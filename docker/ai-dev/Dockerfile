# =========================================
# AIé–‹ç™ºç’°å¢ƒ - Python + PyTorch + Jupyter
# Mac ARM64 / Linux x86_64 ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ
# =========================================

# ãƒžãƒ«ãƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¯¾å¿œãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM --platform=linux/amd64 python:3.11-slim AS base-amd64
FROM --platform=linux/arm64 python:3.11-slim AS base-arm64

# ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥é¸æŠž
ARG TARGETPLATFORM
FROM base-${TARGETPLATFORM#linux/} AS base

# =========================================
# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# =========================================
RUN apt-get update && apt-get install -y \
    # é–‹ç™ºãƒ„ãƒ¼ãƒ«
    git \
    curl \
    wget \
    vim \
    htop \
    tree \
    
    # Pythoné–‹ç™ºä¾å­˜
    build-essential \
    python3-dev \
    python3-pip \
    
    # ç”»åƒãƒ»å‹•ç”»å‡¦ç†
    ffmpeg \
    libsm6 \
    libxext6 \
    libfontconfig1 \
    libxrender1 \
    libgl1-mesa-glx \
    
    # ãã®ä»–ã‚·ã‚¹ãƒ†ãƒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    libglib2.0-0 \
    libgstreamer1.0-0 \
    && rm -rf /var/lib/apt/lists/*

# =========================================
# Pythonç’°å¢ƒè¨­å®š
# =========================================
WORKDIR /workspace

# pip ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
RUN pip install --upgrade pip setuptools wheel

# =========================================
# AI/ML åŸºæœ¬ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# =========================================
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# =========================================
# Jupyter Lab è¨­å®š
# =========================================
RUN jupyter lab --generate-config

# Jupyterè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
RUN echo "c.ServerApp.ip = '0.0.0.0'" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.port = 8888" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.open_browser = False" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.allow_root = True" >> /root/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.token = 'ai-development-2025'" >> /root/.jupyter/jupyter_lab_config.py

# =========================================
# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ä½œæˆ
# =========================================
RUN mkdir -p \
    /workspace/projects \
    /workspace/ai_workspace \
    /workspace/development \
    /workspace/models \
    /workspace/datasets \
    /workspace/notebooks \
    /workspace/scripts \
    /workspace/output

# =========================================
# é–‹ç™ºç’°å¢ƒè¨­å®š
# =========================================

# Gitè¨­å®šï¼ˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®é–‹ç™ºç”¨ï¼‰
RUN git config --global user.name "AI Development Container" && \
    git config --global user.email "ai-dev@development-evolution-2025"

# Python ãƒ‘ã‚¹è¨­å®š
ENV PYTHONPATH="/workspace:/workspace/projects:/workspace/ai_workspace"

# =========================================
# ãƒãƒ¼ãƒˆå…¬é–‹
# =========================================
EXPOSE 8888 8000 6006

# =========================================
# èµ·å‹•è¨­å®š
# =========================================

# èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
RUN echo '#!/bin/bash\n\
echo "ðŸš€ AIé–‹ç™ºç’°å¢ƒãŒèµ·å‹•ã—ã¾ã—ãŸï¼"\n\
echo ""\n\
echo "ðŸ“Š åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹:"\n\
echo "   â€¢ Jupyter Lab: http://localhost:8888 (token: ai-development-2025)"\n\
echo "   â€¢ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼: http://localhost:8000"\n\
echo "   â€¢ TensorBoard: http://localhost:6006"\n\
echo ""\n\
echo "ðŸ“ ãƒžã‚¦ãƒ³ãƒˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:"\n\
echo "   â€¢ /workspace/projects     â†’ AI Projects"\n\
echo "   â€¢ /workspace/development  â†’ Development"\n\
echo "   â€¢ /workspace/ai_workspace â†’ _ai_workspace"\n\
echo ""\n\
echo "ðŸ”§ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒžãƒ³ãƒ‰:"\n\
echo "   â€¢ jupyter lab --ip=0.0.0.0 --port=8888 --allow-root"\n\
echo "   â€¢ python -m http.server 8000"\n\
echo "   â€¢ tensorboard --logdir=/workspace/logs --host=0.0.0.0"\n\
echo ""\n\
\n\
# Jupyter Lab ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•\n\
jupyter lab --ip=0.0.0.0 --port=8888 --allow-root --no-browser &\n\
\n\
# ã‚·ã‚§ãƒ«ä¿æŒ\n\
exec "$@"\n\
' > /workspace/start.sh && chmod +x /workspace/start.sh

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒžãƒ³ãƒ‰
CMD ["/workspace/start.sh", "bash"] 